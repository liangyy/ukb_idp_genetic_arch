---
title: "Individual-level ImageXcan (round 1)"
# author: Yanyu Liang
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

```{r setup}
rm(list = ls())
library(ggplot2)
theme_set(theme_bw(base_size = 15))
source('https://gist.githubusercontent.com/liangyy/43912b3ecab5d10c89f9d4b2669871c9/raw/3ca651cfa53ffccb8422f432561138a46e93710f/my_ggplot_theme.R')
library(dplyr)
options(stringsAsFactors = F)
library(patchwork)
library(data.table)
options(datatable.fread.datatable = F)
pheno_interest = c('weekly_alcohol', 'recurrent_depressive_disorder', 'parent_depression', 'parent_AD', 'handedness', 'daily_coffee', 'daily_cigarettes')
pheno_bcc = c('wbc', 'rbc', 'platelet', 'lymphocyte', 'monocyte', 'neutrophil', 'eosinophil', 'basophil')
pheno_ht = c('dbp', 'sbp') # , 'ht', 'hb', 'mcv', 'mch', 'mchc')
source('rlib.R')
```

# About

See running setup at 

* The original IDPs (residual obtained by Owen): `submission/imagexcan/run_round_1_linear.orignal.screen`.
* dMRI IDP adjusted for first 9 PCs: `submission/imagexcan/run_round_1_linear.dmri.screen`.

The current results are generated by linear regression. 
The logistic regression is ready to go but it has some numerical issue when including too many covariates.

We have special focus on dMRI IDPs.

# Load data

dMRI IDPs.

```{r}
dmri = readRDS('../misc_data/download_some_matching_files/annot_dmri_idps.rds')
dmri = dmri %>% mutate(IDP = paste0('IDP-', FieldID))
```

Load results with original IDPs and adjusted IDPs.

```{r}
# linear solver
df_lm = read.csv('~/Desktop/tmp/ukb_idp/data/imagexcan_round_1.linear.original.csv') %>% filter(IDP %in% dmri$IDP)
df_lm_resid = read.csv('~/Desktop/tmp/ukb_idp/data/imagexcan_round_1.linear.dmri.csv') %>% filter(IDP %in% dmri$IDP)
df_lm = rbind(
  df_lm %>% mutate(idp_type = 'original'),
  df_lm_resid %>% mutate(idp_type = 'regress_out')
)
df_lm = df_lm %>% left_join(dmri %>% select(IDP, measure, position, type, lr), by = 'IDP')
df_lm$lr[ is.na(df_lm$lr) ] = 'NA'
```


# Overall QQ-plot

```{r, fig.width=20, fig.height=5}
p1 = df_lm %>% filter(phenotype %in% pheno_interest) %>% group_by(phenotype, idp_type) %>% mutate(pexp = rank(pval) / (n() + 1)) %>% 
  ggplot() + 
  geom_point(aes(x = -log10(pexp), y = -log10(pval), color = idp_type)) + 
  facet_wrap(~phenotype, scales = 'free_y') + th2 + geom_abline(slope = 1, intercept = 0)

p2 = df_lm %>% filter(phenotype %in% pheno_bcc) %>% group_by(phenotype, idp_type) %>% mutate(pexp = rank(pval) / (n() + 1)) %>% 
  ggplot() + 
  geom_point(aes(x = -log10(pexp), y = -log10(pval), color = idp_type)) + 
  facet_wrap(~phenotype, scales = 'free_y') + th2 + geom_abline(slope = 1, intercept = 0)

p3 = df_lm %>% filter(phenotype %in% pheno_ht) %>% group_by(phenotype, idp_type) %>% mutate(pexp = rank(pval) / (n() + 1)) %>% 
  ggplot() + 
  geom_point(aes(x = -log10(pexp), y = -log10(pval), color = idp_type)) + 
  facet_wrap(~phenotype, scales = 'free_y') + th2 + geom_abline(slope = 1, intercept = 0)
p1 + p2 + p3
```

# Focus on one brain region

```{r, fig.width=20, fig.height=5}
region = 'medial lemniscus'
p1 = df_lm %>% filter(phenotype %in% pheno_interest, position == region) %>% group_by(phenotype, idp_type) %>% mutate(pexp = rank(pval) / (n() + 1)) %>% 
  ggplot() + 
  geom_point(aes(x = -log10(pexp), y = -log10(pval), color = idp_type)) + 
  facet_wrap(~phenotype, scales = 'free_y') + th2 + geom_abline(slope = 1, intercept = 0)

p2 = df_lm %>% filter(phenotype %in% pheno_bcc, position == region) %>% group_by(phenotype, idp_type) %>% mutate(pexp = rank(pval) / (n() + 1)) %>% 
  ggplot() + 
  geom_point(aes(x = -log10(pexp), y = -log10(pval), color = idp_type)) + 
  facet_wrap(~phenotype, scales = 'free_y') + th2 + geom_abline(slope = 1, intercept = 0)

p3 = df_lm %>% filter(phenotype %in% pheno_ht, position == region) %>% group_by(phenotype, idp_type) %>% mutate(pexp = rank(pval) / (n() + 1)) %>% 
  ggplot() + 
  geom_point(aes(x = -log10(pexp), y = -log10(pval), color = idp_type)) + 
  facet_wrap(~phenotype, scales = 'free_y') + th2 + geom_abline(slope = 1, intercept = 0)
p1 + p2 + p3
```

# Aggregate using ACAT for each region

```{r, fig.width=20, fig.height=5}
df_agg = df_lm %>% group_by(idp_type, phenotype, position) %>% summarize(p_acat = acat(pval)) %>% ungroup()

p1 = df_agg %>% filter(phenotype %in% pheno_interest) %>% group_by(phenotype, idp_type) %>% mutate(pexp = rank(p_acat) / (n() + 1)) %>% 
  ggplot() + 
  geom_point(aes(x = -log10(pexp), y = -log10(p_acat), color = idp_type)) + 
  facet_wrap(~phenotype, scales = 'free_y') + th2 + geom_abline(slope = 1, intercept = 0)

p2 = df_agg %>% filter(phenotype %in% pheno_bcc) %>% group_by(phenotype, idp_type) %>% mutate(pexp = rank(p_acat) / (n() + 1)) %>% 
  ggplot() + 
  geom_point(aes(x = -log10(pexp), y = -log10(p_acat), color = idp_type)) + 
  facet_wrap(~phenotype, scales = 'free_y') + th2 + geom_abline(slope = 1, intercept = 0)

p3 = df_agg %>% filter(phenotype %in% pheno_ht) %>% group_by(phenotype, idp_type) %>% mutate(pexp = rank(p_acat) / (n() + 1)) %>% 
  ggplot() + 
  geom_point(aes(x = -log10(pexp), y = -log10(p_acat), color = idp_type)) + 
  facet_wrap(~phenotype, scales = 'free_y') + th2 + geom_abline(slope = 1, intercept = 0)
p1 + p2 + p3
```

# Bonferroni significant hits

```{r}
df_lm %>% filter(idp_type == 'regress_out') %>% mutate(p_adj = pval * n()) %>% filter(p_adj < 0.05, phenotype %in% pheno_interest) %>% pander::pander(caption = 'Bonferroni significant IDP-level (alpha = 0.05) among all focal traits')
df_agg %>% filter(idp_type == 'regress_out') %>% mutate(p_adj = p_acat * n()) %>% filter(p_adj < 0.05, phenotype %in% pheno_interest) %>% pander::pander(caption = 'Bonferroni significant region-level (alpha = 0.05) among all focal traits')
```


<!-- ```{r, fig.height=9, fig.width=16} -->
<!-- for(mm in unique(df_lm$measure)) { -->
<!--   p = df_lm %>% filter(measure == mm) %>% group_by(phenotype, idp_type, lr) %>% mutate(pexp = rank(pval) / (n() + 1)) %>% ggplot() + geom_point(aes(x = -log10(pexp), y = -log10(pval), color = idp_type)) + facet_grid(lr~phenotype) + geom_abline(slope = 1, intercept = 0) + ggtitle(paste0('Measurement = ', mm)) -->
<!--   print(p) -->
<!--   # ggsave(paste0('imagexcan_dmri.', mm, '.png'), p, width = 16, height = 9) -->
<!-- } -->

<!-- ``` -->


<!-- # Right vs Left -->

<!-- ```{r} -->
<!-- df_lm %>% filter(idp_type == 'regress_out', lr != 'NA') %>% reshape2::dcast(phenotype + idp_type + measure + position + type ~ lr, value.var = 'bhat') %>% ggplot() + geom_point(aes(x = left, y = right), alpha = 0.2) + facet_wrap(~phenotype, scales = 'free') + ggtitle('Bhat comparison') + geom_abline(slope = 1, intercept = 0, color = 'gray') -->

<!-- df_lm %>% filter(idp_type == 'regress_out', lr != 'NA') %>% reshape2::dcast(phenotype + idp_type + measure + position + type ~ lr, value.var = 'pval') %>% ggplot() + geom_point(aes(x = -log10(left), y = -log(right)), alpha = 0.2) + facet_wrap(~phenotype, scales = 'free') + ggtitle('P-value comparison')  -->
<!-- ``` -->

