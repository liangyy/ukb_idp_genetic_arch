---
title: "Individual-level ImageXcan (round 1)"
# author: Yanyu Liang
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

```{r setup}
rm(list = ls())
library(ggplot2)
theme_set(theme_bw(base_size = 15))
source('https://gist.githubusercontent.com/liangyy/43912b3ecab5d10c89f9d4b2669871c9/raw/3ca651cfa53ffccb8422f432561138a46e93710f/my_ggplot_theme.R')
library(dplyr)
options(stringsAsFactors = F)
library(patchwork)
library(data.table)
options(datatable.fread.datatable = F)
```

# About

See running setup at `submission/imagexcan/run_round_1_linear.screen` and `submission/imagexcan/run_round_1_logistic.screen`.

We have special focus on dMRI IDPs.

# Load data

dMRI IDPs.

```{r}
dmri = readRDS('../misc_data/download_some_matching_files/annot_dmri_idps.rds')
dmri = dmri %>% mutate(IDP = paste0('IDP-', FieldID))
```

```{r}
# linear solver
df_lm = read.csv('~/Desktop/tmp/ukb_idp/data/imagexcan_round_1.linear.csv') %>% filter(IDP %in% dmri$IDP)
df_lm_resid = read.csv('~/Desktop/tmp/ukb_idp/data/imagexcan_round_1.linear.dmri.csv') %>% filter(IDP %in% dmri$IDP)
df_lm = rbind(
  df_lm %>% mutate(idp_type = 'original'),
  df_lm_resid %>% mutate(idp_type = 'regress_out')
)
df_lm = df_lm %>% left_join(dmri %>% select(IDP, measure, position, type, lr), by = 'IDP')
df_lm$lr[ is.na(df_lm$lr) ] = 'NA'
```


```{r, fig.height=9, fig.width=16}
for(mm in unique(df_lm$measure)) {
  p = df_lm %>% filter(measure == mm) %>% group_by(phenotype, idp_type, lr) %>% mutate(pexp = rank(pval) / (n() + 1)) %>% ggplot() + geom_point(aes(x = -log10(pexp), y = -log10(pval), color = idp_type)) + facet_grid(lr~phenotype) + geom_abline(slope = 1, intercept = 0) + ggtitle(paste0('Measurement = ', mm))
  print(p)
  # ggsave(paste0('imagexcan_dmri.', mm, '.png'), p, width = 16, height = 9)
}

```


# Right vs Left

```{r}
df_lm %>% filter(idp_type == 'regress_out', lr != 'NA') %>% reshape2::dcast(phenotype + idp_type + measure + position + type ~ lr, value.var = 'bhat') %>% ggplot() + geom_point(aes(x = left, y = right), alpha = 0.2) + facet_wrap(~phenotype, scales = 'free') + ggtitle('Bhat comparison') + geom_abline(slope = 1, intercept = 0, color = 'gray')

df_lm %>% filter(idp_type == 'regress_out', lr != 'NA') %>% reshape2::dcast(phenotype + idp_type + measure + position + type ~ lr, value.var = 'pval') %>% ggplot() + geom_point(aes(x = -log10(left), y = -log(right)), alpha = 0.2) + facet_wrap(~phenotype, scales = 'free') + ggtitle('P-value comparison') 
```

